---
title: "CVE-2024-50286: Lỗ hổng Use-After-Free trong Linux Kernel KSMBD"
date: 2025-01-07T10:30:00+07:00
draft: false
tags: ["ksmbd", "Linux Kernel", "SMB", "CVE-2024-50286", "Use-After-Free", "Race Condition", "DoS", "RCE", "vulnerability", "system security"]
categories: ["Cyber Security", "Software Tool"]
---

![Linux Kernel ksmbd Use-After-Free Vulnerability](/images/2025/Linux-Kernel-ksmbd-Use-After-Free-Vulnerability-DeepSeas.jpg)

### Giới thiệu: Về KSMBD trong Linux Kernel

KSMBD là một module nhân Linux cung cấp chức năng máy chủ SMB (Server Message Block). Được thiết kế để cải thiện hiệu suất và tích hợp chặt chẽ hơn với nhân hệ điều hành, KSMBD là một giải pháp thay thế hiệu quả cho các máy chủ SMB không gian người dùng truyền thống như Samba, đặc biệt trong việc chia sẻ tệp và máy in trong môi trường mạng.

### Lỗ hổng CVE-2024-50286: Điều kiện Race và Use-After-Free

**CVE-2024-50286** là một lỗ hổng nghiêm trọng được phân loại là Use-After-Free (UAF), phát sinh từ điều kiện race do thiếu cơ chế đồng bộ hóa phù hợp trong quá trình quản lý bảng `sessions_table` của KSMBD [1][2][3].

*   **Nguyên nhân:** Lỗ hổng này xảy ra khi các hoạt động tạo hoặc hết hạn session trong `sessions_table` không được bảo vệ bằng các khóa đồng bộ hóa cần thiết (cụ thể là thiếu `sessions_table_lock`). Điều này cho phép nhiều luồng truy cập và sửa đổi dữ liệu session cùng một lúc. Trong một kịch bản race condition, một luồng có thể giải phóng một đối tượng session trong khi một luồng khác vẫn đang tham chiếu đến nó, dẫn đến lỗi Use-After-Free trong bộ nhớ kernel (`kmalloc-512`) [1][3].
*   **Hậu quả:** Lỗi UAF này có thể dẫn đến các tác động nghiêm trọng:
    *   **Tấn công Từ chối Dịch vụ (DoS):** Hệ thống có thể bị treo hoặc khởi động lại (kernel panic) khi cố gắng truy cập vào vùng bộ nhớ không hợp lệ, làm gián đoạn dịch vụ SMB [2].
    *   **Leo thang Đặc quyền Cục bộ (Local Privilege Escalation):** Kẻ tấn công có quyền truy cập cục bộ với đặc quyền thấp có thể lợi dụng lỗi này để ghi đè dữ liệu kernel hoặc kiểm soát luồng thực thi, từ đó leo thang đặc quyền lên cấp độ kernel [1][2][3].
    *   **Thực thi Mã Tùy ý (RCE):** Mặc dù chủ yếu được phân loại là lỗ hổng cục bộ (CVSS v3.1 cơ bản là 7.0 với vector tấn công cục bộ [2]), một số phân tích cho thấy tiềm năng khai thác thành thực thi mã từ xa trong các điều kiện nhất định, đặc biệt nếu kẻ tấn công có thể kiểm soát được vùng nhớ đã được giải phóng và chèn mã độc vào đó [4].

### Các lỗ hổng KSMBD khác có thể dẫn đến DoS từ xa

Trước CVE-2024-50286, KSMBD cũng đã từng đối mặt với các lỗ hổng nghiêm trọng khác, trong đó một số có thể gây tấn công DoS từ xa:

*   **Lỗ hổng nghiêm trọng (CVSS 10.0, công bố 12/2022):** Một lỗ hổng cực kỳ nghiêm trọng (ví dụ như CVE-2022-47939) đã được phát hiện vào năm 2022, ảnh hưởng đến các máy chủ SMB chạy KSMBD [5]. Kẻ tấn công từ xa, không cần xác thực, có thể lợi dụng việc xử lý không đúng lệnh `SMB2_TREE_DISCONNECT` để gây crash hệ thống hoặc thực thi mã từ xa.
*   **Lỗ hổng rò rỉ bộ nhớ (Memory Leak):** Tương tự như một số lỗi rò rỉ bộ nhớ khác, KSMBD cũng có thể gặp phải các lỗ hổng cho phép kẻ tấn công từ xa đọc được các thông tin nhạy cảm từ bộ nhớ kernel hoặc gây ra tình trạng cạn kiệt bộ nhớ dẫn đến DoS.

### Tóm tắt các lỗ hổng KSMBD gây DoS từ xa và cục bộ

| CVE | Phiên bản ảnh hưởng | Loại lỗ hổng | Mức độ | Khả năng khai thác | Mô tả ngắn |
| :------------- | :----------------- | :------------------------ | :------ | :---------------------- | :-------------------------------------------------------------------------- |
| CVE-2024-50286 | Nhiều (2024) | Race Condition, Use-After-Free | Cao (CVSS 7.0) | Cục bộ (tiềm năng RCE) [2][4] | Lỗi đồng bộ hóa `sessions_table`, dẫn đến DoS và leo thang đặc quyền cục bộ |
| (Chưa rõ mã, 2022) | < 5.15.61 | Invalid Object Access, DoS | Rất cao (CVSS 10.0) | Từ xa (RCE) [5] | Lỗi xử lý `SMB2_TREE_DISCONNECT` gây crash hoặc RCE |
| (Chưa rõ mã) | Nhiều | Memory Leak | Trung bình | Từ xa | Rò rỉ thông tin hoặc cạn kiệt bộ nhớ, dẫn đến DoS |

**Lưu ý:** Lỗ hổng CVE-2024-50286 chủ yếu yêu cầu quyền truy cập cục bộ với đặc quyền thấp. Tuy nhiên, các lỗ hổng KSMBD trước đây đã từng cho phép khai thác DoS và RCE từ xa.

### Các kịch bản tấn công và tác động

1.  **Tấn công Từ chối Dịch vụ (DoS):** Đây là kịch bản phổ biến nhất cho nhiều lỗ hổng KSMBD. Kẻ tấn công có thể gửi các yêu cầu SMB độc hại được chế tạo đặc biệt đến máy chủ KSMBD bị ảnh hưởng. Các yêu cầu này kích hoạt lỗ hổng, làm cho nhân hệ điều hành bị treo hoặc khởi động lại, khiến dịch vụ SMB không khả dụng [2]. Điều này có thể gây gián đoạn hoạt động kinh doanh, mất dữ liệu tạm thời và thiệt hại tài chính.
2.  **Leo thang Đặc quyền Cục bộ (Local Privilege Escalation):** Đối với CVE-2024-50286, kẻ tấn công đã có quyền truy cập cục bộ với đặc quyền thấp có thể lợi dụng lỗi UAF để thực hiện tấn công leo thang đặc quyền. Bằng cách thao túng bộ nhớ kernel, kẻ tấn công có thể đạt được quyền root trên hệ thống.
3.  **Thực thi Mã Từ xa (RCE):** Mặc dù CVE-2024-50286 chủ yếu là lỗ hổng cục bộ, tiềm năng RCE vẫn tồn tại trong một số kịch bản khai thác phức tạp hoặc đối với các lỗ hổng KSMBD khác. Khi mã độc được thực thi ở quyền kernel, kẻ tấn công có thể:
    *   Cài đặt backdoor
    *   Truy cập, sửa đổi hoặc xóa dữ liệu nhạy cảm
    *   Leo thang đặc quyền hoàn toàn
    *   Triển khai các phần mềm độc hại khác
    *   Kiểm soát hoàn toàn hệ thống [4].

### Biện pháp phòng ngừa và khắc phục

Để bảo vệ hệ thống khỏi các lỗ hổng KSMBD, các quản trị viên hệ thống cần thực hiện ngay các biện pháp sau:

1.  **Cập nhật nhân Linux:** Đây là biện pháp quan trọng nhất. Luôn đảm bảo rằng nhân Linux trên hệ thống của bạn được cập nhật lên phiên bản mới nhất. Các bản vá lỗi cho CVE-2024-50286 và các vấn đề bảo mật khác đã được tích hợp vào các phiên bản kernel gần đây [3]. Đối với các lỗ hổng KSMBD cũ hơn (ví dụ như CVE-2022-47939), cần cập nhật lên kernel **≥ 5.15.61** hoặc các phiên bản vá lỗi tương đương.
2.  **Vô hiệu hóa KSMBD nếu không cần thiết:** Nếu hệ thống của bạn không sử dụng KSMBD để chia sẻ tệp SMB, hãy xem xét việc vô hiệu hóa hoặc gỡ bỏ module này để giảm thiểu bề mặt tấn công.
3.  **Áp dụng nguyên tắc đặc quyền tối thiểu (Least Privilege):** Đảm bảo rằng các tài khoản người dùng và dịch vụ chỉ có các quyền cần thiết để thực hiện công việc của chúng. Điều này giúp hạn chế thiệt hại nếu một tài khoản bị xâm phạm, đặc biệt trong trường hợp leo thang đặc quyền cục bộ.
4.  **Giám sát mạng và hệ thống:** Triển khai các công cụ giám sát mạng và hệ thống (ví dụ: SIEM, IDS/IPS) để phát hiện các hoạt động bất thường hoặc dấu hiệu của việc khai thác lỗ hổng.
5.  **Kiểm tra lỗ hổng định kỳ:** Sử dụng các công cụ quét lỗ hổng để định kỳ kiểm tra hệ thống của bạn và xác định các lỗ hổng tiềm ẩn.
6.  **Thực hiện sao lưu thường xuyên:** Duy trì các bản sao lưu dữ liệu quan trọng để có thể phục hồi hệ thống trong trường hợp bị tấn công thành công.

### Kết luận

Lỗ hổng CVE-2024-50286 trong Linux Kernel KSMBD, cùng với các lỗ hổng khác, đặt ra một mối đe dọa đáng kể cho các hệ thống sử dụng module này. Khả năng gây ra tấn công DoS, leo thang đặc quyền cục bộ và tiềm năng RCE đòi hỏi các quản trị viên hệ thống phải hành động nhanh chóng và quyết liệt. Bằng cách ưu tiên cập nhật nhân Linux, vô hiệu hóa các dịch vụ không cần thiết và áp dụng các biện pháp bảo mật mạnh mẽ, chúng ta có thể giảm thiểu rủi ro và bảo vệ cơ sở hạ tầng của mình khỏi các cuộc tấn công tiềm tàng. Luôn cảnh giác và chủ động trong việc bảo trì an ninh hệ thống là chìa khóa để đối phó với các mối đe dọa an ninh mạng ngày càng tinh vi.

## Nguồn tham khảo

[1] Doyensec. (2025, January 7). *ksmbd vulnerability research - Doyensec's Blog*. Truy cập từ: https://blog.doyensec.com/2025/01/07/ksmbd-1.html
[2] NVD. (2024, November 18). *CVE-2024-50286 Detail*. Truy cập từ: https://nvd.nist.gov/vuln/detail/CVE-2024-50286
[3] Debian Security Tracker. (2024, January 1). *CVE-2024-50286*. Truy cập từ: https://security-tracker.debian.org/tracker/CVE-2024-50286
[4] DeepSeas. (2024, December 2). *Linux Kernel ksmbd Use-After-Free Vulnerability*. Truy cập từ: https://www.deepseas.com/linux-kernel-ksmbd-use-after-free-vulnerability-deepseas-cyber-defense/
[5] SecurityAffairs.com. *Critical Linux Kernel flaw affects SMB servers with ksmbd enabled*.